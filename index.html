<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="deck/theme/redhat-light.css">
		<link rel="stylesheet" href="deck/css/main.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section id="cover" data-background-image="deck/red-textured-background.svg">
                  <img src="deck/redhat-logo-reverse.svg" id="rht-cover-logo">

                  <div id="cover-title">Building Apache Spark cloud services in Python</div>

                  <div id="cover-name">
                    Michael McCune<br/>
                    msm@redhat.com<br/>
                    elmiko.github.io<br/>
                  </div>
                </section>

                <section data-background-image="deck/transparent-textured-background.svg" data-markdown>
                  <script type="text/template">
#### What is a cloud service?

![](deck/cncf.png) <!-- .element: id="cncf-logo" class="center fragment pad-before-1" -->

* Containerized <!-- .element: class="fragment pad-before-1" -->
* Dynamically orchestrated <!-- .element: class="fragment" -->
* Microservice oriented <!-- .element: class="fragment" -->
* <!-- .element: class="fragment" --> **cncf.io/about/faq**

\#devconfus <!-- .element: class="hashtag" -->
                  </script>
                </section>

                <section data-background-image="deck/transparent-textured-background.svg" data-markdown>
                  <script type="text/template">
#### OpenShift Kubernetes

![](deck/openshift-architecture.png) <!-- .element: class="center frame-500 pad-before-1" -->

\#devconfus <!-- .element: class="hashtag" -->
                  </script>
                </section>

                <section data-background-image="deck/transparent-textured-background.svg">
                  <section>
                    <h4>Apache Spark</h4>
                    <img src="deck/spark-arch.svg" id="sparkarch" class="center pad-before-1">
                    <p class="hashtag">#devconfus</p>
                  </section>

                  <section>
                    <h4>The fundamental Spark abstraction</h4>
                    <div class="frame-500 frame-column frame-center">
                      <div class="center">
                        <span id="rdd">Resilient distributed dataset (RDD)</span>
                      </div>
                      <div class="center fragment pad-before-1">
                        <span id="rdd-desc">are
                          <span class="red">partitioned</span>,
                          <span class="red">lazy</span>,
                          and <span class="red">immutable</span>
                          homogenous collections</span>
                      </div>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>

                  <section>
                    <h4>Resilient distributed datasets in action</h4>
                    <div class="pad-before-1" class="center" style="display: flex;">
                      <img src="deck/example-array.svg" height="100px" class="fragment">
                      <img src="deck/example-parallelize.svg" height="100px" class="fragment">
                    </div>
                    <div class="pad-before-1" class="center" style="display: flex;">
                      <img src="deck/example-rdd1.svg" height="100px" class="fragment">
                      <img src="deck/example-filter.svg" height="100px" class="fragment">
                    </div>
                    <div class="pad-before-1" style="display: flex;">
                      <img src="deck/example-rdd2.svg" height="100px" class="fragment">
                      <div class="fragment">
                        <img src="deck/example-count.svg" height="100px">
                        <img src="deck/example-result.svg" height="100px">
                      </div>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>
                </section>

                <section data-background-image="deck/transparent-textured-background.svg" data-markdown>
                  <script type="text/template">
#### Spark on OpenShift

![](deck/spark-openshift.svg) <!-- .element: class="center frame-500 pad-before-1" -->

\#devconfus <!-- .element: class="hashtag" -->
                  </script>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <section data-markdown>
                    <script type="text/template">
#### What is a Spark application?

![](deck/what-is-a-spark-app.svg) <!-- .element: class="center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section>
                    <h4>simple.py</h4>
                    <div class="frame-500">
                      <pre><code data-trim data-noescape>import sys
from pyspark.sql import SparkSession

spark = SparkSession.builder.appName("simple").getOrCreate()

data = range(int(sys.argv[1]))

<span class="fragment highlight-red">evens = spark.sparkContext \
           .parallelize(data) \
           .filter(lambda x: x%2 == 0) \
           .count()</span>

print("Out of 0-{} there are {} even numbers."
      .format(sys.argv[1], evens))
                      </code></pre>

                      <p class="hashtag">#devconfus</p>
                    </div>
                  </section>

                  <section>
                    <div class="frame-600">
                      <img src="deck/simple-spark-no-loop.gif" class="center">
                    </div>
                      <p class="hashtag">#devconfus</p>
                  </section>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <section data-markdown>
                    <script type="text/template">
#### Designing a Spark microservice

![](deck/ingest-process-publish.svg) <!-- .element: class="center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### Consider your structural needs

![](deck/before-code.svg) <!-- .element: width="800px" class="center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>
                  <section data-markdown>
                    <script type="text/template">
#### Common architectures

![](deck/architectures.svg) <!-- .element: width="800px" class="center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <section data-markdown>
                    <script type="text/template">
#### On-demand batch processing

![](deck/on-demand-batch.svg) <!-- .element: class="center frame-500 pad-before-1" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### When to use this pattern?

* Non-deterministic request windows <!-- .element: class="pad-before-3" -->
* Quick to calculate results
* Situational dependencies

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section>
                    <h4>Hello World of Spark</h4>
                    <pre><code data-trim data-noescape>def produce_pi(scale):
    spark = SparkSession.builder.appName("PythonPi")\
             .getOrCreate()
    n = 100000 * scale

    def f(_):
        from random import random
        x = random()
        y = random()
        return 1 if x ** 2 + y ** 2 <= 1 else 0

    <span class="fragment highlight-red">count = spark.sparkContext \
               .parallelize(xrange(1, n + 1), scale) \
               .map(f) \
               .reduce(lambda x, y: x + y)</span>

    spark.stop()
    pi = 4.0 * count / n
    return pi
                    </pre></code>
                    <p class="hashtag">#devconfus</p>
                  </section>

                  <section>
                    <h4>Embedded in an HTTP server</h4>
                    <div class="pad-before-1">
                      <pre><code data-trim data-noescape>@app.route("/sparkpi")
def sparkpi():
    scale = int(request.args.get('scale', 2))
    <span class="fragment highlight-red">pi = produce_pi(scale)</span>
    response = "Pi is roughly {}".format(pi)

    return response</pre></code>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <section data-markdown>
                    <script type="text/template">
#### Continuous batch processing

![](deck/continuous-batch.svg) <!-- .element: class="center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### When to use this pattern?

* Frequently updating source data <!-- .element: class="pad-before-3" -->
* Machine learning model evaluation
* Lifecycle management processes

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section>
                    <h4>Continuous model generation</h4>
                      <pre><code data-trim data-noescape>while True:
     cursor.execute("SELECT * FROM ratings")
     current_ratings_length = cursor.rowcount

     if current_ratings_length != ratings_length:
         ratings_length = current_ratings_length
         ratings = cursor.fetchall()
         <span class="fragment highlight-red" data-fragment-index="1">ratingsRDD = sc.parallelize(ratings)
         ratingsRDD = ratingsRDD.map(
                                 lambda x: (x[0], x[1], x[2]))</span>
         model_version += 1
         logger.info("model version={}".format(model_version))
         <span class="fragment highlight-red" data-fragment-index="1">model = modeller.Trainer(data=ratingsRDD,
                             rank=parameters['rank'],
                             iterations=parameters['iteration'],
                             lambda_ = parameters['lambda'],
                             seed=42).train()</span>
         writer.write(model=model, version=model_version)
     else:
         time.sleep(120)</pre></code>
                      <p class="hashtag">#devconfus</p>
                  </section>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <section data-markdown>
                    <script type="text/template">
#### Stream processing

![](deck/stream-processing.svg) <!-- .element: class="pad-before-1 center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### When to use this pattern?

* Real-time event processing <!-- .element: class="pad-before-3" -->
* Broadcast message systems
* Kappa style architectures


\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section>
                    <h4>Structured stream processing</h4>
                    <div class="pad-before-1">
                    <pre><code data-trimdata-noescape>spark = SparkSession.builder.appName("grafzahl").getOrCreate()
spark \
  .readStream \
   .format("kafka") \
    .option("kafka.bootstrap.servers", servers) \
     .option("subscribe", topic) \
      .load() \
  <span class="fragment highlight-red" data-fragment-index="1">.selectExpr("CAST(value AS STRING)") \
   .groupBy("value") \
    .count()</span> \
  .writeStream \
   .outputMode("complete") \
    <span class="fragment highlight-red" data-fragment-index="1">.format("memory") \
     .queryName("results") \</span>
  .start()</pre></code>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>
                  <section>
                    <h4>Structured stream processing</h4>
                    <div class="pad-before-1">
                    <pre><code data-trim data-noescape>def top_results(request):
   <span class="fragment highlight-red">results = spark.sql(
       "SELECT * FROM results ORDER BY count DESC LIMIT {}" \
         .format(int(request.args.get('n') or 10))) \
       .collect()</span>
   return (map(lambda x: x.value, results),
           map(lambda x: x['count'], results))</pre></code>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### Kappa style architectures

![](deck/stream-processing-kappa.svg) <!-- .element: class="pad-before-1 center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section>
                    <h4>Kappa counter</h4>
                    <pre><code data-trimdata-noescape>spark = SparkSession.builder.appName("kappagraf").getOrCreate()
spark \
  .readStream \
   .format("kafka") \
    .option("kafka.bootstrap.servers", servers) \
     .option("subscribe", intopic) \
      .load() \
  .selectExpr("CAST(value AS STRING)") \
   .groupBy("value") \
    .count() \
  <span class="fragment highlight-red">.writeStream \
    .format('kafka') \
      .option('kafka.bootstrap.servers', servers) \
      .option('topic', outtopic) \
      .option('checkpointLocation', '/tmp') \</span>
  .start()</pre></code>
                    <p class="hashtag">#devconfus</p>
                  </section>
                </section>

                <section data-background-image="deck/transparent-textured-background.svg">
                  <section data-markdown>
                    <script type="text/template">
#### Taking your code to the cloud

![](deck/code-to-cloud.svg) <!-- .element: width="800px" class="pad-before-1 center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### Spark on OpenShift with Oshinko

![](deck/oshinko-source-to-image.svg) <!-- .element: class="pad-before-1 center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section>
                    <div class="frame frame-center">
                      <h3>oshinko in action</h3>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <section>
                    <h4>Synchronicity</h4>
                    <div class="frame-500">
                      <img src="deck/synch-left.svg">
                      <div class="frame-column center">
                        <img src="deck/synch-center-1.svg" class="fragment">
                        <img src="deck/synch-center-2.svg" class="fragment">
                      </div>
                      <img src="deck/synch-right.svg">
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### Separate control and processing

![](deck/synchronicity.svg) <!-- .element: class="pad-before-1 center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>

                  <section>
                    <h4>Main control</h4>
                    <div class="pad-before-1">
                    <pre><code data-trim data-noescape><span class="fragment highlight-red">import multiprocessing as mp</span>
# queues for ipc with the prediction process
request_q = mp.Queue()
response_q = mp.Queue()

# start the prediction process
process = mp.Process(target=predictions.loop,
                     args=(request_q, response_q)
process.start()

# waiting for processing loop to become active
response_q.get()</pre></code>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>
                  <section>
                    <h4>Processing loop</h4>
                    <div>
                    <pre><code data-trim data-noescape>def loop(request_q, response_q):
    spark = pysql.SparkSession.builder.appName("JiminyRec")\
            .getOrCreate()
    sc = spark.sparkContext
    # let the main process know we are ready to start
    <span class="fragment highlight-red" data-fragment-index="1">response_q.put('ready')</span>
    while True:
        <span class="fragment highlight-red" data-fragment-index="1">req = request_q.get()</span>
        if req == 'stop':
             break
         resp = req
         if 'topk' in req:
             # make rank predictions
             # ...
             <span class="fragment highlight-red" data-fragment-index="1">response_q.put(resp)</span>
         else:
             # make rating predictions
             # ...
             <span class="fragment highlight-red" data-fragment-index="1">response_q.put(resp)</span></code></pre>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <section>
                    <h4>Mind your dependencies</h4>
                    <div>
                      <pre><code class="python hljs stylus" data-noescape>import sys
import pymongo
from pyspark.sql import SparkSession

def filter_evens(value):
    if value % 2 == 0:
        <span class="fragment highlight-red" data-fragment-index="1">db = pymongo.MongoClient().evens</span>
        doc = db.counts.find_one({"value": value})
        if doc is not None:
            count = doc["count"] + 1
            db.counts.replace_one({"_id": doc["_id"]},
                    {"value": value, "count": count})
        else:
            db.counts.insert_one({"value": value, "count": 1})

spark = SparkSession.builder.appName("simple").getOrCreate()

data = range(int(sys.argv[1]))

evens = spark.sparkContext.parallelize(data)\
         <span class="fragment highlight-red" data-fragment-index="1">.filter(filter_evens)\</span>
         .count() </pre></code>
                    </div>
                    <p class="hashtag">#devconfus</p>
                  </section>

                  <section data-markdown>
                    <script type="text/template">
#### Dependency management

![](deck/spark-dependencies.svg) <!-- .element: width="800px" class="pad-before-1 center frame-500" -->

\#devconfus <!-- .element: class="hashtag" -->
                    </script>
                  </section>
                </section>

				<section data-background-image="deck/transparent-textured-background.svg">
                  <div class="frame frame-center">
                  <div class="flex">
                    <div class="flex frame-column pad-right-2">
                      <img src="deck/ingest-process-publish.svg" class="center pad-before-1" width="300px">
                      <img src="deck/architectures-mini.svg" class="center pad-before-3" width="450px">
                      <img src="deck/oshinko-source-to-image.svg" class="center pad-before-3" width="400px">
                    </div>
                    <div class="flex frame-column">
                      <img src="deck/qrcode.png" class="center" width="300px">
                      <p class="final"> msm@redhat.com<br/>
                      elmiko.github.io<br/><br/>
                      <span class="finalrad">radanalytics.io</span></p>

                    </div>
                  </div>
                  </div>

                    <p class="hashtag">#devconfus</p>
                  </script>
                </section>

			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				history: true,

                controls: false,
                slideNumber: true,
                center: false,

				// More info https://github.com/hakimel/reveal.js#dependencies
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});
		</script>
	</body>
</html>
